name: Build and Release Flutter App

on:
  push:
    branches:
      - main
    paths:
      - 'lib/**'
      - 'pubspec.yaml'
      - 'android/**'
      - '.github/workflows/build.yml'
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
    paths:
      - 'lib/**'
      - 'pubspec.yaml'
  workflow_dispatch:

jobs:
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Auto-increment version
        id: version_bump
        run: |
          # Get current version from pubspec.yaml
          CURRENT_VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //' | tr -d ' ')
          VERSION_NAME=$(echo $CURRENT_VERSION | cut -d'+' -f1)
          BUILD_NUMBER=$(echo $CURRENT_VERSION | cut -d'+' -f2)
          
          # Increment build number
          NEW_BUILD_NUMBER=$((BUILD_NUMBER + 1))
          NEW_VERSION="${VERSION_NAME}+${NEW_BUILD_NUMBER}"
          
          # Update pubspec.yaml
          sed -i "s/version: $CURRENT_VERSION/version: $NEW_VERSION/" pubspec.yaml
          
          # Output versions
          echo "old_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "build_number=$NEW_BUILD_NUMBER" >> $GITHUB_OUTPUT
          
          echo "Version bumped: $CURRENT_VERSION -> $NEW_VERSION"

      - name: Commit version bump
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add pubspec.yaml
          git commit -m "chore: bump version to ${{ steps.version_bump.outputs.new_version }} [skip ci]" || echo "No changes to commit"
          git push || echo "Nothing to push"

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.0'
          channel: 'stable'
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Run tests
        run: flutter test
        continue-on-error: true

      - name: Analyze code
        run: flutter analyze
        continue-on-error: true

      - name: Build APK (Debug)
        run: flutter build apk --debug
        
      - name: Build APK (Release)
        run: flutter build apk --release --target-platform android-arm64

      - name: Build App Bundle
        run: flutter build appbundle --release

      - name: Upload APK Debug
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-debug
          path: build/app/outputs/flutter-apk/app-debug.apk

      - name: Upload APK Release
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-release
          path: build/app/outputs/flutter-apk/app-release.apk

      - name: Upload App Bundle
        uses: actions/upload-artifact@v4
        with:
          name: android-appbundle
          path: build/app/outputs/bundle/release/app-release.aab

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-android]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Android APK
        uses: actions/download-artifact@v4
        with:
          name: android-apk-release
          path: ./artifacts

      - name: Download Android App Bundle
        uses: actions/download-artifact@v4
        with:
          name: android-appbundle
          path: ./artifacts

      - name: Get version from pubspec.yaml
        id: version
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //' | tr -d ' ')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Get previous release tag
        id: prev_tag
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          echo "tag=$PREV_TAG" >> $GITHUB_OUTPUT
          echo "Previous tag: $PREV_TAG"

      - name: Generate changelog from commits
        id: changelog
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //' | tr -d ' ' | cut -d'+' -f1)
          PREV_TAG="${{ steps.prev_tag.outputs.tag }}"
          
          # Generate commit log
          if [ -z "$PREV_TAG" ]; then
            # If no previous tag, get all commits
            COMMITS=$(git log --pretty=format:"- %s by @%an in %h" --no-merges)
          else
            # Get commits since last tag
            COMMITS=$(git log $PREV_TAG..HEAD --pretty=format:"- %s by @%an in %h" --no-merges)
          fi
          
          # Also extract from CHANGELOG.md for structured changes
          CHANGELOG_CONTENT=$(awk "/## \[$VERSION\]/,/## \[/" CHANGELOG.md | sed '/## \[/d' | sed '/^---/d' | sed '/^\[.*\]:/d')
          
          # Combine both
          {
            echo 'content<<EOF'
            if [ ! -z "$CHANGELOG_CONTENT" ]; then
              echo "$CHANGELOG_CONTENT"
              echo ""
              echo "### üìã Commit History"
              echo "$COMMITS"
            else
              echo "$COMMITS"
            fi
            echo EOF
          } >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Release v${{ steps.version.outputs.version }}
          body: |
            ## üì± SiRapat App v${{ steps.version.outputs.version }}
            
            **Sistem Informasi Rapat - Diskominfo Badung**
            
            ---
            
            ### üì¶ Downloads
            - **Android APK**: `app-release.apk` *(Recommended for direct installation)*
            - **Android App Bundle**: `app-release.aab` *(For Google Play Store)*
            
            ---
            
            ### üìù What's Changed
            ${{ steps.changelog.outputs.content }}
            
            ---
            
            ### üîß Installation Guide
            1. Download `app-release.apk` from the downloads section above
            2. Enable "Install from Unknown Sources" in your device settings
            3. Open the APK file and follow the installation prompts
            4. Grant necessary permissions when prompted
            
            ---
            
            ### üìñ Documentation
            - **Full Changelog**: [CHANGELOG.md](https://github.com/RanggaCasper/sirapat-app/blob/main/CHANGELOG.md)
            - **README**: [View Documentation](https://github.com/RanggaCasper/sirapat-app/blob/main/README.md)
          draft: false
          prerelease: false
          files: |
            ./artifacts/app-release.apk
            ./artifacts/app-release.aab
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
