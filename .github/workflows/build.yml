name: Build and Release Flutter App

permissions:
  contents: write

on:
  push:
    branches:
      - main
    paths:
      - 'lib/**'
      - 'pubspec.yaml'
      - 'android/**'
      - '.github/workflows/build.yml'
  workflow_dispatch:

jobs:
  build-android:
    name: Build Android APK & AAB
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: gradle

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.38.0"
          channel: stable
          cache: true

      - name: Decode Android keystore
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/sirapat-release.keystore

      - name: Create key.properties
        run: |
          cat <<EOF > android/key.properties
          storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          storeFile=sirapat-release.keystore
          EOF

      - run: flutter pub get
      - run: flutter test
        continue-on-error: true
      - run: flutter analyze
        continue-on-error: true

      - run: flutter build apk --release
      - run: flutter build appbundle --release

      - uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: build/app/outputs/flutter-apk/app-release.apk

      - uses: actions/upload-artifact@v4
        with:
          name: android-aab
          path: build/app/outputs/bundle/release/app-release.aab

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build-android
    permissions:
      contents: write
    if: github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/download-artifact@v4
        with:
          name: android-apk
          path: artifacts

      - uses: actions/download-artifact@v4
        with:
          name: android-aab
          path: artifacts

      - name: Get version name
        id: version
        run: |
          FULL_VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //' | tr -d ' ')
          VERSION_NAME=$(echo "$FULL_VERSION" | cut -d'+' -f1)
          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT

      - name: Get previous tag
        id: prev_tag
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          echo "tag=$PREV_TAG" >> $GITHUB_OUTPUT

      - name: Generate changelog
        id: changelog
        run: |
          PREV_TAG="${{ steps.prev_tag.outputs.tag }}"
          if [ -z "$PREV_TAG" ]; then
            COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            COMMITS=$(git log $PREV_TAG..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi
          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version_name }}
          name: Release v${{ steps.version.outputs.version_name }}
          body: |
            ## üì± SiRapat App v${{ steps.version.outputs.version_name }}

            **Sistem Informasi Rapat - Diskominfo Badung**

            ---

            ### üì¶ Downloads
            - **Android APK**: `app-release.apk` *(Recommended for direct installation)*
            - **Android App Bundle**: `app-release.aab` *(For Google Play Store)*

            ---

            ### üìù What's Changed
            ${{ steps.changelog.outputs.content }}

            ---

            ### üîß Installation Guide
            1. Download `app-release.apk` from the downloads section above
            2. Enable "Install from Unknown Sources" in your device settings
            3. Open the APK file and follow the installation prompts
            4. Grant necessary permissions when prompted

            ---

            ### üìñ Documentation
            - **Full Changelog**: [CHANGELOG.md](https://github.com/RanggaCasper/sirapat-app/blob/main/CHANGELOG.md)
            - **README**: [View Documentation](https://github.com/RanggaCasper/sirapat-app/blob/main/README.md)
          files: |
            artifacts/app-release.apk
            artifacts/app-release.aab
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}